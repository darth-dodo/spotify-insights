name: ğŸ¤– Auto-merge Dependabot PRs

on:
  pull_request_target:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  dependabot:
    name: ğŸ” Dependabot Auto-merge
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Get Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: âœ… Check if auto-merge is allowed
        id: check-automerge
        run: |
          UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
          DEPENDENCY_NAME="${{ steps.metadata.outputs.dependency-names }}"
          
          echo "Update type: $UPDATE_TYPE"
          echo "Dependency: $DEPENDENCY_NAME"
          
          # Auto-merge rules:
          # - patch updates for all dependencies
          # - minor updates for devDependencies
          # - exclude major updates (require manual review)
          
          if [[ "$UPDATE_TYPE" == "version-update:semver-patch" ]]; then
            echo "âœ… Patch update - auto-merge allowed"
            echo "automerge=true" >> $GITHUB_OUTPUT
          elif [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]] && [[ "${{ steps.metadata.outputs.dependency-type }}" == "direct:development" ]]; then
            echo "âœ… Minor dev dependency update - auto-merge allowed"
            echo "automerge=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Major update or production dependency - manual review required"
            echo "automerge=false" >> $GITHUB_OUTPUT
          fi

      - name: â³ Wait for CI to complete
        if: steps.check-automerge.outputs.automerge == 'true'
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'âœ… Quality Gate'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success

      - name: âœ… Approve PR
        if: steps.check-automerge.outputs.automerge == 'true'
        run: |
          gh pr review --approve "${{ github.event.pull_request.number }}" \
            --body "ğŸ¤– **Dependabot Auto-approval**

          âœ… **Update Type**: ${{ steps.metadata.outputs.update-type }}
          ğŸ“¦ **Dependency**: ${{ steps.metadata.outputs.dependency-names }}
          ğŸ”„ **From**: ${{ steps.metadata.outputs.previous-version }}
          ğŸ”„ **To**: ${{ steps.metadata.outputs.new-version }}

          This PR has been automatically approved because:
          - âœ… CI checks have passed
          - âœ… Update type is safe for auto-merge
          - âœ… Security scan completed successfully

          The PR will be auto-merged once all checks complete."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Enable auto-merge
        if: steps.check-automerge.outputs.automerge == 'true'
        run: |
          gh pr merge --auto --squash "${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Add manual review label
        if: steps.check-automerge.outputs.automerge == 'false'
        run: |
          gh pr edit "${{ github.event.pull_request.number }}" \
            --add-label "ğŸ” manual-review-required" \
            --add-label "ğŸ“‹ major-update"
          
          gh pr comment "${{ github.event.pull_request.number }}" \
            --body "âš ï¸ **Manual Review Required**

          This Dependabot PR requires manual review because:
          - ğŸ“Š **Update Type**: ${{ steps.metadata.outputs.update-type }}
          - ğŸ“¦ **Dependency**: ${{ steps.metadata.outputs.dependency-names }}
          - ğŸ”„ **Version Change**: ${{ steps.metadata.outputs.previous-version }} â†’ ${{ steps.metadata.outputs.new-version }}

          **Why manual review is needed:**
          - Major version updates may contain breaking changes
          - Production dependencies need careful evaluation
          - Please review the changelog and test thoroughly

          **Next steps:**
          1. ğŸ” Review the dependency changelog
          2. ğŸ§ª Test the application locally
          3. âœ… Approve and merge if everything works correctly"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 